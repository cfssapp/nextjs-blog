"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getExposeFromContent = void 0;
const assert_1 = __importDefault(require("assert"));
const path_1 = require("path");
const getModuleExports_1 = require("./getModuleExports");
function getExposeFromContent(opts) {
    return __awaiter(this, void 0, void 0, function* () {
        // Support CSS
        if (opts.filePath &&
            /\.(css|less|scss|sass|stylus|styl)$/.test(opts.filePath)) {
            return `import '${opts.dep.file}';`;
        }
        // Support Assets Files
        if (opts.filePath &&
            /\.(json|svg|png|jpe?g|avif|gif|webp|ico|eot|woff|woff2|ttf|txt|text|mdx?)$/.test(opts.filePath)) {
            return `
import _ from '${opts.dep.file}';
export default _;`.trim();
        }
        (0, assert_1.default)(/(js|jsx|mjs|ts|tsx)$/.test(opts.filePath), `file type not supported for ${(0, path_1.basename)(opts.filePath)}.`);
        const { exports, isCJS } = yield (0, getModuleExports_1.getModuleExports)({
            content: opts.content,
            filePath: opts.filePath,
        });
        // cjs
        if (isCJS) {
            return [
                `import _ from '${opts.dep.file}';`,
                `export default _;`,
                `export * from '${opts.dep.file}';`,
            ].join('\n');
        }
        // esm
        else {
            const ret = [];
            let hasExports = false;
            if (exports.includes('default')) {
                ret.push(`import _ from '${opts.dep.file}';`);
                ret.push(`export default _;`);
                hasExports = true;
            }
            if (hasNonDefaultExports(exports) ||
                // export * from 不会有 exports，只会有 imports
                /export\s+\*\s+from/.test(opts.content)) {
                ret.push(`export * from '${opts.dep.file}';`);
                hasExports = true;
            }
            if (!hasExports) {
                // 只有 __esModule 的全量导出
                if (exports.includes('__esModule')) {
                    ret.push(`import _ from '${opts.dep.file}';`);
                    ret.push(`export default _;`);
                    ret.push(`export * from '${opts.dep.file}';`);
                }
                else {
                    ret.push(`import '${opts.dep.file}';`);
                }
            }
            return ret.join('\n');
        }
    });
}
exports.getExposeFromContent = getExposeFromContent;
function hasNonDefaultExports(exports) {
    return (exports.filter((exp) => !['__esModule', 'default'].includes(exp))
        .length > 0);
}
