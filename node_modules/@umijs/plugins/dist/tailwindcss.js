"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const plugin_utils_1 = require("umi/plugin-utils");
exports.default = (api) => {
    api.describe({
        key: 'tailwindcss',
        config: {
            schema(Joi) {
                return Joi.object();
            },
        },
        enableBy: api.EnableBy.config,
    });
    let tailwind = null;
    const outputPath = 'plugin-tailwindcss/tailwind.css';
    api.onBeforeCompiler(() => {
        const inputPath = (0, path_1.join)(api.cwd, 'tailwind.css');
        const generatedPath = (0, path_1.join)(api.paths.absTmpPath, outputPath);
        const binPath = (0, path_1.join)(api.cwd, 'node_modules/.bin/tailwind');
        /** 透过子进程建立 tailwindcss 服务，将生成的 css 写入 generatedPath */
        tailwind = (0, plugin_utils_1.crossSpawn)(`${binPath}`, [
            '-i',
            inputPath,
            '-o',
            generatedPath,
            api.env === 'development' ? '--watch' : '',
        ], {
            stdio: 'inherit',
        });
        tailwind.on('error', (m) => {
            api.logger.error('tailwindcss service encounter an error: ' + m);
        });
    });
    /** 将生成的 css 文件加入到 import 中 */
    api.addEntryImports(() => {
        const generatedPath = (0, plugin_utils_1.winPath)((0, path_1.join)(api.paths.absTmpPath, outputPath));
        return [{ source: generatedPath }];
    });
};
